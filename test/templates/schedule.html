{% extends "base.html" %}

{% block title %}{{ get_translation('schedule_for') }} {{ room.name }} - {{ get_translation('app_title') }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-calendar me-2"></i>
                {{ get_translation('schedule_for') }} {{ room.name }}
            </h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                {{ get_translation('back') }}
            </a>
        </div>

        <!-- Week View Calendar -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center mb-3">
                    <div class="col-md-6">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-1"></i>
                            {{ get_translation('select_date', 'Select a date') }}
                        </h5>
                    </div>
                    <div class="col-md-6 mt-3 mt-md-0">
                        <div class="text-md-end">
                            <strong>{{ room.name }}</strong><br>
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ room.location }}
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Current Week -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-calendar-week me-1"></i>
                        {{ get_translation('current_week', 'This Week') }}
                    </h6>
                    <div class="row g-2" id="currentWeek">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Next Week -->
                <div>
                    <h6 class="text-secondary mb-3">
                        <i class="fas fa-calendar-week me-1"></i>
                        {{ get_translation('next_week', 'Next Week') }}
                    </h6>
                    <div class="row g-2" id="nextWeek">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Display -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    {{ get_translation('schedule_for') }} <span id="selectedDateDisplay">{{ selected_date }}</span>
                    <small class="text-muted ms-2" id="refreshIndicator" style="display: none;">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        Updating...
                    </small>
                </h5>
            </div>
            <div class="card-body">
                <div id="scheduleDisplay">
                    <div id="bookingsList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>{{ get_translation('loading', 'Loading schedule...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success message for new bookings -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                    {% for category, message in messages %}
                        {% if category == 'success' %}
                            <i class="fas fa-check-circle me-2"></i>
                            {{ message }}
                        {% endif %}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Quick Actions -->
        <div class="text-center mt-4">
            <a href="{{ url_for('book_room', room_id=room.id) }}" class="btn btn-primary">
                <i class="fas fa-calendar-plus me-2"></i>
                {{ get_translation('book_room') }}
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomId = {{ room.id }};
    const currentWeekDiv = document.getElementById('currentWeek');
    const nextWeekDiv = document.getElementById('nextWeek');
    const bookingsListDiv = document.getElementById('bookingsList');
    let selectedDate = '{{ selected_date }}'; // Use the date from URL or today
    let refreshInterval = null;
    
    // Company mapping for display
    const companies = {
        {% for company in companies %}
        '{{ company.id }}': '{{ company.name }}',
        {% endfor %}
    };
    
    // Initialize week view
    initializeWeekView();
    
    // Auto-load today's schedule if no date selected
    if (selectedDate) {
        loadScheduleForDate(selectedDate);
        startAutoRefresh();
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
    
    function initializeWeekView() {
        const today = new Date();
        const currentWeekDates = getWeekDates(today);
        const nextWeekStart = new Date(today);
        nextWeekStart.setDate(today.getDate() + 7);
        const nextWeekDates = getWeekDates(nextWeekStart);
        
        renderWeek(currentWeekDiv, currentWeekDates, 'current');
        renderWeek(nextWeekDiv, nextWeekDates, 'next');
    }
    
    function getWeekDates(startDate) {
        const dates = [];
        const date = new Date(startDate);
        // Get Monday of the week
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        date.setDate(diff);
        
        for (let i = 0; i < 7; i++) {
            dates.push(new Date(date));
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }
    
    function renderWeek(container, dates, weekType) {
        container.innerHTML = '';
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        dates.forEach((date, index) => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'col';
            
            const isToday = date.toDateString() === new Date().toDateString();
            const isPast = date < new Date().setHours(0,0,0,0);
            const dateString = date.toISOString().split('T')[0];
            const isSelected = dateString === selectedDate;
            
            dayDiv.innerHTML = `
                <div class="card h-100 day-card ${isPast ? 'past-day' : ''} ${isToday ? 'today' : ''} ${isSelected ? 'border-primary bg-primary bg-opacity-10' : ''}" 
                     data-date="${dateString}"
                     style="cursor: pointer; transition: all 0.2s;">
                    <div class="card-body text-center p-2">
                        <small class="text-muted d-block">${dayNames[index]}</small>
                        <strong class="d-block">${date.getDate()}</strong>
                        <small class="text-muted">${date.toLocaleDateString('en-US', { month: 'short' })}</small>
                    </div>
                </div>
            `;
            
            // Add click handler
            dayDiv.addEventListener('click', function() {
                selectDate(dateString);
                highlightSelectedDay(this);
            });
            
            container.appendChild(dayDiv);
        });
    }
    
    function highlightSelectedDay(selectedElement) {
        // Remove previous selection
        document.querySelectorAll('.day-card').forEach(card => {
            card.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
        });
        
        // Highlight selected day
        const card = selectedElement.querySelector('.day-card');
        card.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
    }
    
    function selectDate(date) {
        selectedDate = date;
        loadScheduleForDate(date);
        startAutoRefresh();
    }
    
    function startAutoRefresh() {
        // Clear existing interval
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        
        // Refresh every 10 seconds when a date is selected for real-time updates
        refreshInterval = setInterval(() => {
            if (selectedDate) {
                loadScheduleForDate(selectedDate, true);
            }
        }, 10000);
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }
    
    function loadScheduleForDate(date, showIndicator = false) {
        const refreshIndicator = document.getElementById('refreshIndicator');
        
        if (showIndicator && refreshIndicator) {
            refreshIndicator.style.display = 'inline';
        } else if (!showIndicator) {
            bookingsListDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>{{ get_translation('loading') }}</p>
                </div>
            `;
        }
        
        fetch(`/api/schedule/${roomId}?date=${date}`)
            .then(response => response.json())
            .then(data => {
                displayBookings(data.bookings, date);
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                bookingsListDiv.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>{{ get_translation('error_loading') }}</p>
                    </div>
                `;
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
            });
    }
    
    function displayBookings(bookings, date) {
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        if (bookings.length === 0) {
            bookingsListDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-calendar-check fa-2x mb-3"></i>
                    <h6 class="text-muted mb-2">${formattedDate}</h6>
                    <p>{{ get_translation('no_bookings') }}</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="mb-3">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-calendar me-1"></i>
                    ${formattedDate}
                </h6>
            </div>
            <div class="list-group list-group-flush">
        `;
        
        // Sort bookings by start time
        bookings.sort((a, b) => a.start_time.localeCompare(b.start_time));
        
        bookings.forEach(booking => {
            const companyName = companies[booking.user_company] || booking.user_company;
            html += `
                <div class="list-group-item border-0 px-0 py-3 booking-item">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <span class="badge bg-primary rounded-pill px-3 py-2">
                                ${booking.start_time}–${booking.end_time}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="fas fa-user me-1 text-muted"></i>
                                ${booking.user_name}
                            </h6>
                            <p class="mb-1 company-name">
                                <i class="fas fa-building me-1 text-muted"></i>
                                ${companyName}
                            </p>
                            ${booking.purpose ? `
                                <p class="mb-0 text-muted">
                                    <i class="fas fa-clipboard me-1"></i>
                                    ${booking.purpose}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        bookingsListDiv.innerHTML = html;
    }
});
</script>

<style>
.day-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.past-day {
    opacity: 0.6;
}

.today {
    border-color: var(--bs-warning) !important;
    background-color: rgba(var(--bs-warning-rgb), 0.1) !important;
}

.booking-item {
    transition: background-color 0.2s ease;
}

.booking-item:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border-radius: 0.375rem;
}
</style>
{% endblock %}